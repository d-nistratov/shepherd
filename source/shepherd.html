<!DOCTYPE html>

<html>
<head>
  <title>shepherd.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>shepherd.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{extend, removeClass, addClass, hasClass, Evented, getBounds, uniqueId} = Tether.Utils

ATTACHMENT =
  <span class="string">'top'</span>: <span class="string">'top center'</span>
  <span class="string">'left'</span>: <span class="string">'middle right'</span>
  <span class="string">'right'</span>: <span class="string">'middle left'</span>
  <span class="string">'bottom'</span>: <span class="string">'bottom center'</span>

<span class="function"><span class="title">createFromHTML</span></span> = (html) -&gt;
  el = document.createElement(<span class="string">'div'</span>)
  el.innerHTML = html
  el.children[<span class="number">0</span>]

<span class="function"><span class="title">matchesSelector</span></span> = (el, sel) -&gt;
  matches = el.matches ? el.matchesSelector ? el.webkitMatchesSelector ? el.mozMatchesSelector ? el.oMatchesSelector
  <span class="keyword">return</span> matches.call(el, sel)

<span class="function"><span class="title">parseShorthand</span></span> = (obj, props) -&gt;
  <span class="keyword">if</span> <span class="keyword">not</span> obj?
    <span class="keyword">return</span> obj
  <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">typeof</span> obj <span class="keyword">is</span> <span class="string">'object'</span>
    <span class="keyword">return</span> obj
  <span class="keyword">else</span>
    vals = obj.split(<span class="string">' '</span>)

    <span class="keyword">if</span> vals.length &gt; props.length
      vals[<span class="number">0</span>] = vals[<span class="number">0.</span>.vals.length - props.length].join(<span class="string">' '</span>)
      vals.splice <span class="number">1</span>, (vals.length - props.length)

    out = {}
    <span class="keyword">for</span> prop, i <span class="keyword">in</span> props
      out[prop] = vals[i]

    out

<span class="class"><span class="keyword">class</span> <span class="title">Step</span> <span class="keyword">extends</span> <span class="title">Evented</span></span>
  constructor: (<span class="property">@tour</span>, options) -&gt;
    <span class="property">@setOptions</span> options

    @

  setOptions: (<span class="property">@options</span>={}) -&gt;
    <span class="property">@destroy</span>()

    <span class="property">@id</span> = <span class="property">@options</span>.id <span class="keyword">or</span> <span class="property">@id</span> <span class="keyword">or</span> <span class="string">"step-<span class="subst">#{ uniqueId() }</span>"</span>

    <span class="keyword">if</span> <span class="property">@options</span>.<span class="keyword">when</span>
      <span class="keyword">for</span> event, handler <span class="keyword">of</span> <span class="property">@options</span>.<span class="keyword">when</span>
        <span class="property">@on</span> event, handler, @

    <span class="property">@options</span>.buttons ?= [
      text: <span class="string">'Next'</span>
      action: <span class="property">@tour</span>.next
    ]

  getTour: -&gt;
    <span class="property">@tour</span>

  bindAdvance: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>An empty selector matches the step element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    {event, selector} = parseShorthand <span class="property">@options</span>.advanceOn, [<span class="string">'selector'</span>, <span class="string">'event'</span>]

    <span class="function"><span class="title">handler</span></span> = (e) =&gt;
      <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@isOpen</span>()

      <span class="keyword">if</span> selector?
        <span class="keyword">if</span> matchesSelector(e.target, selector)
          <span class="property">@tour</span>.next()
      <span class="keyword">else</span>
        <span class="keyword">if</span> <span class="property">@el</span> <span class="keyword">and</span> e.target <span class="keyword">is</span> <span class="property">@el</span>
          <span class="property">@tour</span>.next()

    document.body.addEventListener event, handler</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: this should also bind/unbind on show/hide</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@on</span> <span class="string">'destroy'</span>, -&gt;
      document.body.removeEventListener event, handler

  getAttachTo: -&gt;
    opts = parseShorthand <span class="property">@options</span>.attachTo, [<span class="string">'element'</span>, <span class="string">'on'</span>]
    opts ?= {}

    <span class="keyword">if</span> <span class="keyword">typeof</span> opts.element <span class="keyword">is</span> <span class="string">'string'</span>
      opts.element = document.querySelector opts.element

      <span class="keyword">if</span> <span class="keyword">not</span> opts.element?
        <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Shepherd step's attachTo was not found in the page"</span>

    opts

  setupTether: -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> Tether?
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Using the attachment feature of Shepherd requires the Tether library"</span>

    opts = <span class="property">@getAttachTo</span>()

    attachment = ATTACHMENT[opts.<span class="literal">on</span> <span class="keyword">or</span> <span class="string">'right'</span>]
    <span class="keyword">if</span> <span class="keyword">not</span> opts.element?
      opts.element = <span class="string">'viewport'</span>
      attachment = <span class="string">'middle center'</span>

    tetherOpts =
      classPrefix: <span class="string">'shepherd'</span>
      element: <span class="property">@el</span>
      constraints: [
        to: <span class="string">'window'</span>
        pin: <span class="literal">true</span>
        attachment: <span class="string">'together'</span>
      ]
      target: opts.element
      offset: opts.offset <span class="keyword">or</span> <span class="string">'0 0'</span>
      attachment: attachment

    <span class="property">@tether</span> = <span class="keyword">new</span> Tether extend(tetherOpts, <span class="property">@options</span>.tetherOptions)

  show: =&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@el</span>?
      <span class="property">@render</span>()

    addClass <span class="property">@el</span>, <span class="string">'shepherd-open'</span>

    <span class="property">@tether</span>?.enable()

    <span class="keyword">if</span> <span class="property">@options</span>.scrollTo
      setTimeout =&gt;
        <span class="property">@scrollTo</span>()

    <span class="property">@trigger</span> <span class="string">'show'</span>

  hide: =&gt;
    removeClass <span class="property">@el</span>, <span class="string">'shepherd-open'</span>

    <span class="property">@tether</span>?.disable()

    <span class="property">@trigger</span> <span class="string">'hide'</span>

  isOpen: =&gt;
    hasClass <span class="property">@el</span>, <span class="string">'shepherd-open'</span>

  cancel: =&gt;
    <span class="property">@hide</span>()

    <span class="property">@trigger</span> <span class="string">'cancel'</span>

  complete: =&gt;
    <span class="property">@hide</span>()

    <span class="property">@trigger</span> <span class="string">'complete'</span>

  scrollTo: =&gt;
    {element} = <span class="property">@getAttachTo</span>()

    element?.scrollIntoView()

  destroy: =&gt;
    <span class="keyword">if</span> <span class="property">@el</span>?
      document.body.removeChild <span class="property">@el</span>
      <span class="keyword">delete</span> <span class="property">@el</span>

    <span class="property">@tether</span>?.destroy()

    <span class="property">@trigger</span> <span class="string">'destroy'</span>

  render: -&gt;
    <span class="keyword">if</span> <span class="property">@el</span>?
      <span class="property">@destroy</span>()

    <span class="property">@el</span> = createFromHTML <span class="string">"&lt;div class='shepherd-step <span class="subst">#{ @options.classes ? '' }</span>' data-id='<span class="subst">#{ @id }</span>'&gt;&lt;/div&gt;"</span>

    content = document.createElement <span class="string">'div'</span>
    content.className = <span class="string">'shepherd-content'</span>
    <span class="property">@el</span>.appendChild content

    <span class="keyword">if</span> <span class="property">@options</span>.title?
      header = document.createElement <span class="string">'header'</span>
      header.innerHTML = <span class="string">"&lt;h3 class='shepherd-title'&gt;<span class="subst">#{ @options.title }</span>&lt;/h3&gt;"</span>
      <span class="property">@el</span>.className += <span class="string">' shepherd-has-title'</span>
      content.appendChild header

    <span class="keyword">if</span> <span class="property">@options</span>.text?
      text = createFromHTML <span class="string">"&lt;div class='shepherd-text'&gt;&lt;/div&gt;"</span>

      paragraphs = <span class="property">@options</span>.text
      <span class="keyword">if</span> <span class="keyword">typeof</span> paragraphs <span class="keyword">is</span> <span class="string">'string'</span>
        paragraphs = [paragraphs]

      <span class="keyword">for</span> paragraph <span class="keyword">in</span> paragraphs
        text.innerHTML += <span class="string">"&lt;p&gt;<span class="subst">#{ paragraph }</span>&lt;/p&gt;"</span>

      content.appendChild text

    footer = document.createElement <span class="string">'footer'</span>

    <span class="keyword">if</span> <span class="property">@options</span>.buttons
      buttons = createFromHTML <span class="string">"&lt;ul class='shepherd-buttons'&gt;&lt;/ul&gt;"</span>

      <span class="keyword">for</span> cfg <span class="keyword">in</span> <span class="property">@options</span>.buttons
        button = createFromHTML <span class="string">"&lt;li&gt;&lt;a class='shepherd-button <span class="subst">#{ cfg.classes ? '' }</span>'&gt;<span class="subst">#{ cfg.text }</span>&lt;/a&gt;"</span>
        buttons.appendChild button

        <span class="property">@bindButtonEvents</span> cfg, button.querySelector(<span class="string">'a'</span>)

      footer.appendChild buttons

    content.appendChild footer

    document.body.appendChild <span class="property">@el</span>

    <span class="property">@setupTether</span>()

    <span class="keyword">if</span> <span class="property">@options</span>.advanceOn
      <span class="property">@bindAdvance</span>()

  bindButtonEvents: (cfg, el) -&gt;
    cfg.events ?= {}
    <span class="keyword">if</span> cfg.action?</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Including both a click event and an action is not supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cfg.events.click = cfg.action

    <span class="keyword">for</span> event, handler <span class="keyword">of</span> cfg.events
      <span class="keyword">if</span> <span class="keyword">typeof</span> handler <span class="keyword">is</span> <span class="string">'string'</span>
        page = handler
        <span class="function"><span class="title">handler</span></span> = =&gt;
          <span class="property">@tour</span>.show page

      el.addEventListener event, handler

    <span class="property">@on</span> <span class="string">'destroy'</span>, -&gt;
      <span class="keyword">for</span> event, handler <span class="keyword">of</span> cfg.events
        el.removeEventListener event, handler

<span class="class"><span class="keyword">class</span> <span class="title">Tour</span> <span class="keyword">extends</span> <span class="title">Evented</span></span>
  constructor: (<span class="property">@options</span>={}) -&gt;
    <span class="property">@steps</span> = <span class="property">@options</span>.steps ? []</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Pass these events onto the global Shepherd object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> event <span class="keyword">in</span> [<span class="string">'complete'</span>, <span class="string">'cancel'</span>, <span class="string">'hide'</span>, <span class="string">'start'</span>, <span class="string">'show'</span>]
      <span class="property">@on</span> event, (opts={}) =&gt;
        opts.tour = @
        Shepherd.trigger event, opts

    @

  addStep: (name, step) -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> step?
      step = name

    <span class="keyword">unless</span> step <span class="keyword">instanceof</span> Step
      <span class="keyword">if</span> <span class="keyword">typeof</span> name <span class="keyword">in</span> [<span class="string">'string'</span>, <span class="string">'number'</span>]
        step.id = name.toString()

      step = extend {}, <span class="property">@options</span>.defaults, step

      step = <span class="keyword">new</span> Step(@, step)
    <span class="keyword">else</span>
      step.tour = @

    <span class="property">@steps</span>.push step
    
    step

  getById: (id) -&gt;
    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="property">@steps</span> <span class="keyword">when</span> step.id <span class="keyword">is</span> id
      <span class="keyword">return</span> step

  getCurrentStep: -&gt;
    <span class="property">@currentStep</span>

  next: =&gt;
    index = <span class="property">@steps</span>.indexOf(<span class="property">@currentStep</span>)

    <span class="keyword">if</span> index <span class="keyword">is</span> <span class="property">@steps</span>.length - <span class="number">1</span>
      <span class="property">@hide</span> index
      <span class="property">@trigger</span> <span class="string">'complete'</span>
      <span class="property">@done</span>()
    <span class="keyword">else</span>
      <span class="property">@show</span>(index + <span class="number">1</span>)

  back: =&gt;
    index = <span class="property">@steps</span>.indexOf(<span class="property">@currentStep</span>)

    <span class="property">@show</span>(index - <span class="number">1</span>)

  cancel: =&gt;
    <span class="property">@currentStep</span>?.cancel()

    <span class="property">@trigger</span> <span class="string">'cancel'</span>
    <span class="property">@done</span>()

  hide: =&gt;
    <span class="property">@currentStep</span>?.hide()

    <span class="property">@trigger</span> <span class="string">'hide'</span>
    <span class="property">@done</span>()

  done: -&gt;
    Shepherd.activeTour = <span class="literal">null</span>

  show: (key=<span class="number">0</span>) -&gt;
    <span class="keyword">if</span> <span class="property">@currentStep</span>
      <span class="property">@currentStep</span>.hide()

    Shepherd.activeTour = @

    <span class="keyword">if</span> <span class="keyword">typeof</span> key <span class="keyword">is</span> <span class="string">'string'</span>
      next = <span class="property">@getById</span> key
    <span class="keyword">else</span>
      next = <span class="property">@steps</span>[key]

    <span class="keyword">if</span> next
      <span class="property">@trigger</span> <span class="string">'show'</span>, {step: next, previous: <span class="property">@currentStep</span>}

      <span class="property">@currentStep</span> = next
      next.show()

  start: -&gt;
    <span class="property">@trigger</span> <span class="string">'start'</span>

    <span class="property">@currentStep</span> = <span class="literal">null</span>
    <span class="property">@next</span>()

Shepherd = <span class="keyword">new</span> Evented

extend Shepherd, {Tour, Step, Evented}

window.Shepherd = Shepherd</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
